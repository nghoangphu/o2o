var fs = require('fs');
var path = require('path');

function find(pmodule, dir) {
  if (!dir) {
    dir = path.dirname(pmodule.filename);
  }

  var pkgFile = path.join(dir, 'package.json');

  try {
    var stats = fs.statSync(pkgFile);

    if (stats.isFile()) {
      return pkgFile;
    }
  } catch (err) {
    // Ignore the err
  }

  if (dir === '/') {
    throw new Error('Could not find package.json up from: ' + dir);
  } else if (!dir || dir === '.') {
    throw new Error('Cannot find package.json from unspecified directory');
  }

  return find(pmodule, path.dirname(dir));
}

function readRootPackage(pmodule) {
  var pkg = find(pmodule);

  var data = fs.readFileSync(pkg).toString();

  return {
    dir: path.dirname(pkg),
    package: JSON.parse(data)
  };
}

module.exports = readRootPackage;
