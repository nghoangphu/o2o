var debug = require('debug')('strongloop-license:file');
var fs = require('fs');

module.exports = fileLicenses;

// path of JSON file containing:
// [ { licenseKey: 'lic', ...}, ... ]

function fileLicenses(path) {
  var lics = safeChain(path, fs.readFileSync, JSON.parse, extractLics);
  lics = lics || [];
  debug('loaded %d licenses from %s', lics.length, path);
  return lics;

  function extractLics(subs) {
    var licenses = subs.licenses || subs;
    if (!Array.isArray(licenses)) {
      throw new Error('Invalid licenses: ' + subs);
    }
    return licenses.map(function(sub) {
      return sub.licenseKey;
    }).filter(blank);
  }

  function blank(str) {
    return !!str;
  }
}

function safeChain(init, fns) {
  fns = [].slice.call(arguments, 1);
  return fns.reduce(attempt, init);

  function attempt(prev, fn) {
    try {
      return fn(prev);
    } catch (e) {
      return null;
    }
  }
}
