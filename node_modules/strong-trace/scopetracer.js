"use strict";

module.exports = ScopeTracer

var scopenodes = require("./scopenodes")
var applyChangelist = require("./apply_changelist")

function ScopeTracer(mutator, nodeTest) {
  if (!(this instanceof ScopeTracer)) return new ScopeTracer(mutator, nodeTest)

  if (!mutator) {
    throw new Error("You must provide a mutator function.")
  }

  this.mutator = mutator

  if (nodeTest) {
    this.nodeTest = nodeTest
  }
  else {
    // Default node test = keep all nodes
    this.nodeTest = function () { return true }
  }
}

ScopeTracer.prototype.transform = function transform(content) {
  if (!content) {
    return content
  }
  var nodes = scopenodes(content)

  var changelist = []

  for (var i = 0; i < nodes.length; i++) {
    var node = nodes[i]
    if (!this.nodeTest.apply(node, arguments)) {
      continue
    }

    changelist = changelist.concat(this.mutator.apply(node, arguments))
  }

  return applyChangelist(content, changelist)
}
